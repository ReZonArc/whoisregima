name: WHOIS Record Management

on:
  schedule:
    # Run daily at 3 AM UTC to check for WHOIS changes
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches:
      - main
      - master
    paths:
      - 'regima-domains.txt'
      - 'scripts/whois-checker.js'
      - '.github/workflows/whois-checker.yml'

jobs:
  whois-management:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        npm install

    - name: Build project
      run: |
        npm run build

    - name: Create whois directory structure
      run: |
        mkdir -p whois/json
        mkdir -p whois/md  
        mkdir -p whois/archive

    - name: Make script executable
      run: |
        chmod +x scripts/whois-checker.js

    - name: Run WHOIS checker
      run: |
        echo "🔍 Checking WHOIS records for changes..."
        # Add retry logic for network reliability
        for attempt in 1 2 3; do
          echo "Attempt $attempt of 3..."
          if node scripts/whois-checker.js; then
            echo "✅ WHOIS checker completed successfully"
            break
          else
            if [ $attempt -eq 3 ]; then
              echo "❌ WHOIS checker failed after 3 attempts"
              exit 1
            fi
            echo "⚠️ Attempt $attempt failed, retrying in 30 seconds..."
            sleep 30
          fi
        done

    - name: Check for changes
      id: check-changes
      run: |
        # First, add all whois files to staging to detect new files
        git add whois/ --force
        
        # Check if there are any changes (staged files) in the whois directory
        if git diff --quiet --cached -- whois/ && [ -z "$(find whois/ -name '*.json' -o -name '*.md' 2>/dev/null)" ]; then
          echo "No WHOIS changes detected"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "WHOIS changes detected"
          echo "changes=true" >> $GITHUB_OUTPUT
          
          # Show what files were detected
          echo "Detected files:"
          find whois/ -name '*.json' -o -name '*.md' 2>/dev/null | head -10 | while read file; do
            echo "  - $file"
          done
        fi

    - name: Show changes summary
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "📊 WHOIS Changes Summary:"
        echo "======================="
        
        # Count files in each directory
        JSON_COUNT=$(find whois/json -name "*.json" 2>/dev/null | wc -l)
        MD_COUNT=$(find whois/md -name "*.md" 2>/dev/null | wc -l)
        ARCHIVE_COUNT=$(find whois/archive -name "*" -type f 2>/dev/null | wc -l)
        
        echo "📄 JSON files: ${JSON_COUNT}"
        echo "📝 Markdown files: ${MD_COUNT}" 
        echo "🗄️ Archive files: ${ARCHIVE_COUNT}"
        
        # Show recent changes
        echo ""
        echo "Recent updates:"
        git diff --name-only HEAD -- whois/ | head -10

    - name: Commit and push changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Files are already staged from the check-changes step
        
        # Count updates for detailed commit message
        JSON_COUNT=$(find whois/json -name "*.json" 2>/dev/null | wc -l || echo "0")
        MD_COUNT=$(find whois/md -name "*.md" 2>/dev/null | wc -l || echo "0")
        ARCHIVE_COUNT=$(find whois/archive -name "*" -type f 2>/dev/null | wc -l || echo "0")
        
        # Create comprehensive commit message
        COMMIT_MSG="🔍 WHOIS records update - Complete data preservation"$'\n\n'"- JSON records: ${JSON_COUNT}"$'\n'"- Markdown summaries: ${MD_COUNT}"$'\n'"- Historical archives: ${ARCHIVE_COUNT}"$'\n'"- Generated comprehensive overview in whois/regima.md"$'\n\n'"Automated WHOIS monitoring ensures complete domain data preservation and historical tracking."
        
        # Verify that there are actually files to commit
        if git diff --cached --quiet; then
          echo "❌ Error: No files staged for commit despite changes detected"
          echo "Current staged files:"
          git diff --cached --name-only
          exit 1
        fi
        
        git commit -m "$COMMIT_MSG"
        
        # Verify commit and push with retry logic
        for attempt in 1 2 3; do
          if git push origin HEAD; then
            echo "✅ Successfully pushed WHOIS data to repository"
            break
          else
            if [ $attempt -eq 3 ]; then
              echo "❌ Failed to push after 3 attempts"
              exit 1
            fi
            echo "⚠️ Push attempt $attempt failed, retrying in 10 seconds..."
            sleep 10
          fi
        done

    - name: Verify files were committed
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "🔍 Verifying WHOIS files were committed and pushed..."
        
        # Count committed files
        COMMITTED_JSON=$(git ls-tree -r HEAD -- whois/json/ | grep '\.json$' | wc -l || echo "0")
        COMMITTED_MD=$(git ls-tree -r HEAD -- whois/md/ | grep '\.md$' | wc -l || echo "0")
        
        echo "📊 Verification Results:"
        echo "  Committed JSON files: ${COMMITTED_JSON}"
        echo "  Committed MD files: ${COMMITTED_MD}"
        
        # Verify we have actual files
        if [ "${COMMITTED_JSON}" -eq 0 ] && [ "${COMMITTED_MD}" -eq 0 ]; then
          echo "❌ ERROR: No WHOIS files found in repository after commit!"
          echo "This indicates the workflow failed to properly save files."
          exit 1
        else
          echo "✅ SUCCESS: WHOIS files were properly committed to repository"
          echo "  Total files committed: $((COMMITTED_JSON + COMMITTED_MD))"
        fi

    - name: Create comprehensive summary
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        JSON_COUNT=$(find whois/json -name "*.json" 2>/dev/null | wc -l || echo "0")
        MD_COUNT=$(find whois/md -name "*.md" 2>/dev/null | wc -l || echo "0")
        ARCHIVE_COUNT=$(find whois/archive -name "*" -type f 2>/dev/null | wc -l || echo "0")
        DOMAIN_COUNT=$(wc -l < regima-domains.txt 2>/dev/null | tr -d '[:space:]' || echo "0")
        
        echo "## 🔍 WHOIS Records Update Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 Complete Data Preservation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Data Type | Count | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Domains Monitored** | ${DOMAIN_COUNT} | 🎯 Complete Coverage |" >> $GITHUB_STEP_SUMMARY
        echo "| **JSON Records** | ${JSON_COUNT} | 💾 Machine-readable format |" >> $GITHUB_STEP_SUMMARY
        echo "| **Markdown Files** | ${MD_COUNT} | 📝 Human-readable summaries |" >> $GITHUB_STEP_SUMMARY
        echo "| **Historical Archives** | ${ARCHIVE_COUNT} | 🗄️ Change history preserved |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✅ Repository Enhancements" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- 🔄 **Complete WHOIS Records:** All domain data permanently stored in repository" >> $GITHUB_STEP_SUMMARY
        echo "- 📋 **Comprehensive Overview:** Generated detailed summary in [\`whois/regima.md\`](whois/regima.md)" >> $GITHUB_STEP_SUMMARY
        echo "- 🗂️ **Structured Organization:** JSON, Markdown, and Archive files systematically organized" >> $GITHUB_STEP_SUMMARY
        echo "- 📈 **Data Quality Tracking:** Assessment of completeness for each domain record" >> $GITHUB_STEP_SUMMARY
        echo "- 🔍 **Change Detection:** Historical preservation when domain data changes" >> $GITHUB_STEP_SUMMARY
        echo "- ⚡ **Automated Monitoring:** Daily checks ensure data stays current" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🎯 Repository Impact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The WHOIS database now contains **${JSON_COUNT} complete domain records** with:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Complete WHOIS data preservation in machine and human-readable formats" >> $GITHUB_STEP_SUMMARY
        echo "- Historical tracking with ${ARCHIVE_COUNT} archived records" >> $GITHUB_STEP_SUMMARY
        echo "- Comprehensive overview with statistics and quality assessment" >> $GITHUB_STEP_SUMMARY
        echo "- Permanent storage in repository for reliable access" >> $GITHUB_STEP_SUMMARY

    - name: No changes summary  
      if: steps.check-changes.outputs.changes == 'false'
      run: |
        echo "## ✅ WHOIS Records Current - No Updates Required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All WHOIS records are up-to-date. The comprehensive database remains complete with no detected changes." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show current repository status
        JSON_COUNT=$(find whois/json -name "*.json" 2>/dev/null | wc -l || echo "0")
        MD_COUNT=$(find whois/md -name "*.md" 2>/dev/null | wc -l || echo "0") 
        ARCHIVE_COUNT=$(find whois/archive -name "*" -type f 2>/dev/null | wc -l || echo "0")
        DOMAIN_COUNT=$(wc -l < regima-domains.txt 2>/dev/null | tr -d '[:space:]' || echo "0")
        
        echo "### 📊 Current Repository Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Repository Component | Count | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------------------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Monitored Domains** | ${DOMAIN_COUNT} | 🎯 All tracked |" >> $GITHUB_STEP_SUMMARY
        echo "| **Complete WHOIS Records** | ${JSON_COUNT} | 💾 Up-to-date |" >> $GITHUB_STEP_SUMMARY
        echo "| **Readable Summaries** | ${MD_COUNT} | 📝 Current |" >> $GITHUB_STEP_SUMMARY
        echo "| **Historical Archives** | ${ARCHIVE_COUNT} | 🗄️ Preserved |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔍 Monitoring Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Database Completeness:** All ${JSON_COUNT} domain records are current" >> $GITHUB_STEP_SUMMARY
        echo "- **Change Detection:** No significant updates detected since last check" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Preservation:** Complete WHOIS records safely stored in repository" >> $GITHUB_STEP_SUMMARY
        echo "- **Overview Report:** Comprehensive summary available in [\`whois/regima.md\`](whois/regima.md)" >> $GITHUB_STEP_SUMMARY